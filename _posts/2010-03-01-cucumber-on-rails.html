---
layout: post
title: Cucumber入門(3) 一番最初のCucumber on Rails
date: '2010-03-01T23:51:00.004Z'
author: Suzuki MilanPaak
tags:
- Ruby/ Ruby on Rails
modified_time: '2010-06-09T19:32:05.679+01:00'
blogger_id: tag:blogger.com,1999:blog-6758697817819098194.post-7189496765273396796
blogger_orig_url: http://engineerflies.blogspot.com/2010/02/cucumber-on-rails.html
---

Cucmberはセットアップの時点でいろいろと選択肢があるようです。まずは使ってみましょう。構成の選択肢については<a href=http://engineerflies.blogspot.com/2010/02/cucumber_26.html>前回の記事</a>を参考にしてください。<br /><br /><h1>Cucumberのインストール</h1><br />今回選択した環境は Cucumber + Capybara + Culerity + Rspec + Spork です。さっそくセットアップしていきましょう。<br /><br /><pre class=prettyprint>#gemのインストール<br />sudo gem install cucumber cucumber-rails celerity<br /># Culerityで使用するjrubyのインストール<br />sudo apt-get install jruby <br /># JrubyのgemsにCelerityを追加<br />sudo  /usr/lib/jruby1.2/bin/gem install celerity<br /></pre><br /><br /><br /><h1>サンプルプロジェクトの作成</h1><br />RSSのFeedを登録するだけのアプリケーションを作ってみます。<br />本編と関係ありませんが、rails projectの名前にsampleという接頭辞をつけておくと大変便利です。新しく機能を導入する際に一回使いきりのプロジェクトを用意して思い切り遊べるようにできるからです。いらなくなったらプロジェクトはrm sample* -rで、DBはdrop database samplexxxx_test; で削除すれば良いので間違いが少なくて済みます。<br /><pre class=prettyprint>$ rails -d mysql samplecucmber<br />$ ruby script/generate rspec_scaffold feed url:string<br />:<br />create  db/migrate<br />create  db/migrate/20100228205558_create_feeds.rb<br />route  map.resources :feeds<br /><br />$ rake db:migrate<br /></pre><br /><br /><br /><h1>rails環境のセットアップ</h1><br />まずは--capybara, --rspecオプションだけをつけた状態で実行します。<br /><pre>$ ruby script/generate cucumber --capybara --rspec<br />#設定ファイル。出力先としてreturn.txtが設定されています。<br /><b>create  config/cucumber.yml</b> <br />#同じく設定ファイルですがCucumber実行時のRails環境の動作と必要なconfig.gemを指定しています<br /><b>create  config/environments/cucumber.rb</b> <br /><b>create  script/cucumber</b> #cucumber本体の呼び出しスクリプト<br />create  features/step_definitions<br />create  features/step_definitions/web_steps.rb<br />create  features/support<br />create  features/support/env.rb<br />#ここに<a href=http://wiki.github.com/aslakhellesoy/cucumber/gherkin>Gherkin</a>で書かれたページ名をURLにマップを設定します。<br /><b>create  features/support/paths.rb</b> <br /><b>create  lib/tasks</b><br />#Cucumber関係のrakeタスクを定義<br /><b>create  lib/tasks/cucumber.rake</b> <br /></pre><br />太字は<a href=http://engineerflies.blogspot.com/2010/02/cucumber_23.html>一番最初のcucumber</a>で扱ったプレーンなCucumber環境と比べて増えたファイルです。<br /><br />次に--sporkオプションをつけてsporkの設定に必要なファイルを見てみましょう。<br /><pre>$  ruby script/generate cucumber --spork --force<br />overwrite config/cucumber.yml? (enter "h" for help) [Ynaqdh] Y<br />#DRbが出力に追加されました<br /><b>force  config/cucumber.yml</b> <br />overwrite config/environments/cucumber.rb? (enter "h" for help) [Ynaqdh] Y<br />#config.gemsporkが追加されました<br /><b>force  config/environments/cucumber.rb</b> <br />identical  script/cucumber<br />exists  features/step_definitions<br />identical  features/step_definitions/web_steps.rb<br />exists  features/support<br />overwrite features/support/env.rb? (enter "h" for help) [Ynaqdh] Y                      <br />#require 'spork'が追加されました。requireの記述がSpork.preforkブロックに囲まれました。  <br /><b>force  features/support/env.rb</b> <br />identical  features/support/paths.rb<br />exists  lib/tasks<br />identical  lib/tasks/cucumber.rake<br /></pre><br /><br /><br /><br />次にプロジェクト依存のgemのバージョンをインストールします。この方法で別途gemをインストールするのはgemのバージョンとプロジェクトをそろえて何かの時(人にコードを渡した、しばらくぶりにプロジェクトが再開された)場合にテストを止めないようにするための工夫ではないかと思います。RAILS＿ROOT/config/envioronments/cucumber.rbに以下のような記述がありました。どうもここから必要なgemをインストールしている様です。<br />参考 <a href='http://labs.agenda-style.jp/blog/2009/12/ruby-on-rails-tips---rake-gemsinstall--.html'>Ruby on Rails Tips - rake gems:install</a><br /><br /><pre class=ruby name=code>#当環境のバージョンは以下のとおり。<br />#cucumber (0.6.2)<br />#cucumber-rails (0.2.4)<br /><br />config.gem 'cucumber-rails',   :lib => false, :version => '>=0.2.4' unless File.directory?(File.join(Rails.root, 'vendor/plugins/cucumber-rails'))<br />config.gem 'database_cleaner', :lib => false, :version => '>=0.4.3' unless File.directory?(File.join(Rails.root, 'vendor/plugins/database_cleaner'))<br />config.gem 'capybara',         :lib => false, :version => '>=0.3.0' unless File.directory?(File.join(Rails.root, 'vendor/plugins/capybara'))<br />config.gem 'rspec',            :lib => false, :version => '>=1.3.0' unless File.directory?(File.join(Rails.root, 'vendor/plugins/rspec'))<br />config.gem 'rspec-rails',      :lib => false, :version => '>=1.3.2' unless File.directory?(File.join(Rails.root, 'vendor/plugins/rspec-rails'))<br /><br />config.gem 'spork',            :lib => false, :version => '>=0.7.5' unless File.directory?(File.join(Rails.root, 'vendor/plugins/spork'))<br /></pre><br /><br />プロジェクト依存のgemをインストールします。<br /><pre class=prettyprint>#先に必要なライブラリをインストール<br />sudo aptitude install libxslt1-dev libxml2-dev<br /><br />RAILS_ENV=cucumber rake gems:install<br /></pre><br />このステップでcapybaraがインストールされるはずです。同時に多くの依存するgemがインストールされるので、gemが依存するライブラリがインストールされていない場合はメッセージを出力してcapybaraのインストールが失敗します。該当ライブラリをインストールしてください。<br /><br /><br /><h1>Cucumberを使ったBDD</h1><br />featureの作成<br /><br /><pre class=prettyprint>#feature 'controllerの名前' :オブジェクト変数(script/generate scaffold で指定するのと一緒)<br />$ ruby script/generate feature feed url:string<br />exists  features/step_definitions<br />create  features/manage_feeds.feature<br />create  features/step_definitions/feeds_steps.rb<br /></pre><br /><br /><br />それでは試験を開始します。<br /><pre class=prettyprint>#sporkサーバを立ち上げます。<br />$ ~/.gem/ruby/1.8/bin/spork cuc<br /><br />#drbを設定<br />$ rake cucumber --drb<br /><br />#試験実行<br />$ rake cucumber<br />(in /home/suzukimilanpaak/workspace/ror/samplecucumber)<br />/opt/ruby-enterprise-1.8.7/bin/ruby -I "/opt/ruby-enterprise-1.8.7/lib/ruby/gems/1.8/gems/cucumber-0.6.2/lib:lib" "/opt/ruby-enterprise-1.8.7/lib/ruby/gems/1.8/gems/cucumber-0.6.2/bin/cucumber"  --profile default<br />Using the default profile...<br />Disabling profiles...<br />Feature: Manage feeds<br />In order to [goal]<br />[stakeholder]<br />wants [behaviour]<br /><br /># Rails generates Delete links that use Javascript to pop up a confirmation<br /># dialog and then do a HTTP POST request (emulated DELETE request).<br />#<br /># Capybara must use Culerity or Selenium2 (webdriver) when pages rely on<br /># Javascript events. Only Culerity supports confirmation dialogs.<br />#<br /># cucumber-rails will turn off transactions for scenarios tagged with<br /># @selenium, @culerity, @javascript or @no-txn and clean the database with<br /># DatabaseCleaner after the scenario has finished. This is to prevent data<br /># from leaking into the next scenario.<br />#<br /># Culerity has some performance overhead, and there are two alternatives to using<br /># Culerity:<br />#<br /># a) You can remove the @culerity tag and run everything in-process, but then you<br /># also have to modify your views to use button instead: http://github.com/jnicklas/capybara/issues#issue/12<br />#<br /># b) Replace the @culerity tag with @emulate_rails_javascript. This will detect<br /># the onclick javascript and emulate its behaviour without a real Javascript<br /># interpreter.<br />#<br />@culerity<br />Scenario: Delete feed                    # features/manage_feeds.feature:34<br />Given the following feeds:             # features/step_definitions/feed_steps.rb:1<br />| url   |<br />| url 1 |<br />| url 2 |<br />| url 3 |<br />| url 4 |<br />http://www.example.com/feeds<br />When I delete the 3rd feed             # features/step_definitions/feed_steps.rb:5<br />Then I should see the following feeds: # features/step_definitions/feed_steps.rb:13<br />| Url   |<br />| url 1 |<br />| url 2 |<br />| url 4 |<br /><br />1 scenario (1 passed)<br />3 steps (3 passed)<br />0m14.669s<br /><br /></pre><br />どうでしょううまく通りましたでしょうか？実行エラーはSporkサーバのプロセスの方に吐き出されますので注意してください。これはテストコードがテストを実行しているインタプリタではなくSporkサーバに移譲されているためです。<br /><br /><br /><h1>テストの解説</h1><br />テストの内容について少し解説します。features/manage_feeds.featureを覗いてみましょう。<br /><br />このファイルはrake script/generate featureによって自動作成されました。"５つのurlが与えられていて、url='3'のレコードを削除したとき、その他のレコードが残っている"というシナリオです。<br /><br />Givenのステップで| Url  x |として与えられている値はfeatures/feed_steps.rbに配列として渡されレコードがインサートされます。<br /><pre class=ruby name=code>Given /^the following feeds:$/ do |feeds|<br />Feed.create!(feeds.hashes)<br />end<br /></pre><br /><br />Then句でも||内の値は同様に配列として渡され、htmlの出力結果と異なることを試験します。<br /><pre class=ruby name=code>Then /^I should see the following feeds:$/ do |expected_feeds_table|<br />expected_feeds_table.diff!(tableish('table tr', 'td,th'))<br />end<br /></pre><br /><br /><br />さあ、これで一応cucumberが動くようになりました。GherkinやWhen-Then-Givenの書き方、ヘルパーメソッドなどに集中できる環境が整いました。次回以降また触れたいと思います。<br /><br />.