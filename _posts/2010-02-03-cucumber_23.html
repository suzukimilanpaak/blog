---
layout: post
title: Cucumber入門(1) 一番最初のCucumber
date: '2010-02-03T18:51:00.011Z'
author: Suzuki MilanPaak
tags:
- Ruby/ Ruby on Rails
modified_time: '2012-04-27T05:52:29.397+01:00'
blogger_id: tag:blogger.com,1999:blog-6758697817819098194.post-3822562777713632942
blogger_orig_url: http://engineerflies.blogspot.com/2010/02/cucumber_23.html
---

<b>※. Javascript版のGoogle Searchに対応しました 21, Apl, 2012</b><br/><br/>明日Cucmberについての<a href="http://skillsmatter.com/podcast/agile-testing/using-cucumber-for-bdd-and-agile-acceptance-testing">meetup</a>があるので予習します。   <b>Cucumberとは</b> <br /><blockquote>Cucmberはプレーンなテキストの機能記述を自動テストとして実行するツールです。Cucumberが理解する言語は<a href="https://github.com/cucumber/cucumber/wiki/Gherkin">Gherkin</a>というものです。    CucumberそれそのものはRubyで書かれていますが、Rubyやその他の言語（java、C#とpaythonを含みそれだけではない）で書かれたコードを”テスト”するために使われます。Cucumberは最小限のruby programmingを必要とし、Rubyは簡単です。なのでRubyでないコードを開発していても恐れないでください。  <a href="http://wiki.github.com/aslakhellesoy/cucumber/">githubより</a></blockquote>RailsにCucumberを導入した状態から始めようと思ったのですが、チュートリアルを読み進めていくうちにCucumberを構成するコンポーネントに選択肢がいくつかありCucumber自体規模が大きいことに気づいたので、まずは入門編ということでCucumberをrailsと組み合わせないで動作させてみることにしました。Cucumberの構成については後日また記事にしようと思います。  ちょうど良い記事があったので失礼して拝借させていただきます。  <a href="http://blog.jcoglan.com/2009/10/03/getting-started-with-cucumber-rspec-webrat-and-multiruby/">Getting started with Cucumber, RSpec, Webrat and multiruby</a><br/><br/><br/>Cucumberでは以下のような感じでQAが書いたシナリオ試験や、仕様の振る舞いをGerhkinのフォーマットで自然言語で定義します。<br/><br/>簡単に自然言語で書かれたシナリオ試験をテストコードまでに落とすフローを示します。<br/><br/><br/>1. Gerhkinのフォーマットで書かれたシナリオ - イメージをつかんでもらうための便宜上日本語にしました<br/><br/><pre class='text' name='code'><br />主な特徴:  Google 検索<br />  自分のドキュメントがGoogleで検索できるようになているか確認したい。<br /> <br />  シナリオ: <br />    条件  "https://www.google.com/" <br />    場面  "engineerflies" を検索する<br />    そこで "Cucumber"と表示されている "/url?q=http://engineerflies.blogspot.com" というリンクがあるはず<br /></pre><br/><br/> 2. シナリオの自然言語に正規表現でマッチするような、Webrat（首なしブラウザ） で実施するテストを用意してあげる <pre class='ruby' name='code'><br />条件 /^"([^\"]*)" を開く$/ do |url|  <br /> visit url  <br />end  <br />  <br />場面 /^"([^\"]*)" を検索する$/ do |query|<br />  fill_in "q", :with => query <br />  click_button "Google 検索"<br />end   <br /> <br />そこで /^"([^\"]*)"と表示されている"([^\"]*)" というリンクがあるはず$/ do |url, text|<br />  response_body.should have_selector("a[href^='#{ url }']") do |element|<br />    element.should contain(text)<br />  end<br />end<br /></pre><br/><br/><br/>それでは今回はgoogleでこのブログを検索してヒットするまでをcucumberで検証してみたいと思います。今回のCucmberの構成は以下のとおり。Googleを使うのでWebratを使用します。<br/><br/>Cucmber + Webrat + Mechanize<br/><br/><br/>＊ Webratの代わりにCapybaraという選択肢も考えましたが、Capybaraは<a href="http://github.com/jnicklas/capybara">githubのdescriptionにあるように</a>Rackアプリのテストを前提としているので今回は使用しません。Railsの外で使用する場合、SinatraやMerbで使用する場合は Capybara.app = MyRackApp のようにRackのアプリケーションを渡してあげる必要があります。   <br /><h1>Cucmberのインストール</h1>私の環境では次のバージョンをインストールしました <pre class="prettyprint"> #gemのインストール<br />sudo gem install cucumber -v 0.6.2<br />sudo gem install webrat -v 0.6.0<br />sudo gem install mechanize -v 1.0.0<br />sudo gem install rspec<br /></pre><br/>   <br /><br /><h1>下準備</h1> - Cucumberに必要なディレクトリとファイルの作成 <br />どこでもいいので以下のディレクトリ構成を作成します。 <br /><pre class="prettyprint"> $ mkdir -p cucumber/features #cucumberが実行するのに必要なテストスウィートを用意する場所<br /> $ cd cucumber/features<br /> $ touch search.feature #後で説明するfeatureを定義するファイル<br /> $ mkdir step_definitions #?<br /> $ mkdir support #環境設定ファイル<br /> $ vi support/env.rb<br />require 'webrat'<br /><br />Webrat.configure do |config|<br />  config.mode = :mechanize # Mechanizeを使ってブラウジングする<br />end<br /><br />World(Webrat::Methods)<br />World(Webrat::Matchers)<br /></pre>  とりあえずその状態でcucumberを実行する。 <br /><pre class="prettyprint"> $ cd cucumber<br /> $ cucumber<br />   0 scenarios0 steps<br />   0m0.000s<br /></pre>当然ながらscenarioもstepも無い。scenarioとstepは以下を参照  <br /><h1>Feature</h1>まずfeatures/search.featureに以下を記述。  <br /><pre class="prettyprint"><br />Feature: Search Google<br />  In order to make sure people can find my documentation<br />  I want to check it is listed on the first page in Google<br /><br />  Scenario: Searching for suzukimilanpaak engineerflies<br />    Given I have opened "https://www.google.com/"<br />    When I search for "suzukimilanpaak engineerflies"<br />    Then I should see a link to "/url?q=http://engineerflies.blogspot.com" with text "Cucumber"<br /></pre>  - Cucumberの便宜上の単位 <ul>  <li>Feature: 主要なもの、目玉。 </li>  <li>Scenario: 人間が行う操作のまとまり</li>  <li>Step: 人間が行う操作や結果の最小単位</li></ul>  - 数の関係 一つの.featureファイルに複数のFeatureを書いたら Cucumber::Parser::SyntaxError になりました<br/><br/>単:Feature - 復:Scenario - 復:Step<br/><br/><br/>- Stepの種類<br/><ul>  <li>Given~: ~がという状況が与えられている</li>  <li>When~: ~したとき</li>  <li>Then~: それで~なる(はず)</li></ul><br/><br/> またcucumber実施 <br /><pre class="prettyprint"> $cucumber<br />Feature: Search Google<br />  In order to make sure people can find my documentation<br />  I want to check it is listed on the first page in Google<br /><br />  Scenario: Searching for engineerflies                                                         # features/search.feature:5<br />    Given I have opened "https://www.google.com/"                                               # features/search.feature:6<br />    When I search for "suzukimilanpaak engineerflies"                                           # features/search.feature:7<br />    Then I should see a link to "/url?q=http://engineerflies.blogspot.com" with text "Cucumber" # features/search.feature:8<br /><br />1 scenario (1 undefined)<br />3 steps (3 undefined)<br />0m0.007s<br /><br />You can implement step definitions for undefined steps with these snippets:<br /><br />Given /^I have opened "([^"]*)"$/ do |arg1|<br />  pending # express the regexp above with the code you wish you had<br />end<br /><br />When /^I search for "([^"]*)"$/ do |arg1|<br />  pending # express the regexp above with the code you wish you had<br />end<br /><br />Then /^I should see a link to "([^"]*)" with text "([^"]*)"$/ do |arg1, arg2|<br />  pending # express the regexp above with the code you wish you had<br />end<br /></pre> Scenarioとfeatureの各行末にfeatureの行番号が表示され、その後に結果が表示されます。<br/>1 scenario (1 undefined)<br/>3 steps (3 undefined)<br/>0m0.002s  １つのscenarioが未定義、３つのstepが未定義。まだ、テストを記述していないので当然の結果ですね。<br/><br/>その後に"You can implement step definitions for undefined steps with these snippets:"のメッセージが表示されてます。<br/><br/>仰せのとおりに... <br /><h1>Steps</h1>Stepsを記述していきます。<br/> <br /><h2>Given</h2>features/search_steps.rbを用意します  <br /><pre class="ruby" name="code"> <br />Given /^I have opened "([^\"]*)"$/ do |url|  <br /> visit url  <br />end  <br />  <br />When /^I search for "([^\"]*)"$/ do |arg1| <br />  pending<br />end<br /><br />Then /^I should see a link to "([^\"]*)" with text "([^\"]*)"$/ do |arg1, arg2| <br />    pending  <br />end<br /></pre><br/>再度cucumberを実行 <br/><pre class="prettyprint"><br />Feature: Search Google<br />  In order to make sure people can find my documentation<br />  I want to check it is listed on the first page in Google<br /><br />  Scenario: Searching for suzukimilanpaak engineerflies                                         # features/search.feature:5<br />    Given I have opened "https://www.google.com/"                                               # features/step_definitions/search_steps.rb:1<br />    When I search for "suzukimilanpaak engineerflies"                                           # features/step_definitions/search_steps.rb:5<br />      TODO (Cucumber::Pending)<br />      ./features/step_definitions/search_steps.rb:6:in `/^I search for "([^\"]*)"$/'<br />      features/search.feature:7:in `When I search for "suzukimilanpaak engineerflies"'<br />    Then I should see a link to "/url?q=http://engineerflies.blogspot.com" with text "Cucumber" # features/step_definitions/search_steps.rb:15<br /><br />1 scenario (1 pending)<br />3 steps (1 skipped, 1 pending, 1 passed)<br />0m1.039s<br /></pre>結果を見てみましょう。 1 passed - Givenだけが通りました。<br/><br/><br/>結果の見方<br/>1 passed - Givenのstepが通った<br/>1 pending - Whenはpendingが指定されている<br/>1 skipped - Whenがpendingのため、Thenはskipされた<br/><br/><br/><br /><h2>When</h2>次にWhen にフォーカスします。  <br /><pre class="ruby" name="code"><br />When /^I search for "([^\"]*)"$/ do |query|<br />  #qという名前のHTML要素にqueryを入力<br />  fill_in "q", :with => query <br />  click_button "Google 検索"  <br />end   <br /></pre> <pre class="prettyprint"> <br />Feature: Search Google<br />  In order to make sure people can find my documentation<br />  I want to check it is listed on the first page in Google<br /><br />  Scenario: Searching for suzukimilanpaak engineerflies                                         # features/search.feature:5<br />    Given I have opened "https://www.google.com/"                                               # features/step_definitions/search_steps.rb:1<br />Sorry, you need to install launchy to open pages: `gem install launchy`<br />    When I search for "suzukimilanpaak engineerflies"                                           # features/step_definitions/search_steps.rb:5<br />    Then I should see a link to "/url?q=http://engineerflies.blogspot.com" with text "Cucumber" # features/step_definitions/search_steps.rb:14<br />      TODO (Cucumber::Pending)<br />      ./features/step_definitions/search_steps.rb:15:in `/^I should see a link to "([^\"]*)" with text "([^\"]*)"$/'<br />      features/search.feature:8:in `Then I should see a link to "/url?q=http://engineerflies.blogspot.com" with text "Cucumber"'<br /><br />1 scenario (1 pending)<br />3 steps (1 pending, 2 passed)<br />0m1.111s<br /><br /></pre>Whenも通りましたね。うまく通らない場合はWhen の中でsave_and_open_pageでレスポンスの内容を作業ディレクトリに保存することができます。response_bodyにアクセスすることでGivenでvisit urlした結果、実際に返ってきたレスポンスを見ることができます。<br/><pre><br />When "..." do <br />  save_and_open_page #=> ./webrat-1335366157.html<br /><br />  # Above is equivalent to..<br />  File.open "webrat.html" do |f|<br />    f.puts response_body.inspect<br />  end<br />end<br /></pre> 実際にwebratがどのようなリクエストをしているかは作業ディレクトリの./webrat.logにいかの様なけいしきで保存されます。 <pre><br />D, [2012-04-26T00:17:11.930393 #10569] DEBUG -- : REQUESTING PAGE: GET https://www.google.com/ with {} and HTTP headers {}<br />D, [2012-04-26T00:17:12.267081 #10569] DEBUG -- : REQUESTING PAGE: GET /search with {"btnG"=>"Google \346\244\234\347\264\242", "hl"=>"ja", "gbv"=>"1", "q"=>"suzukimilanpaak engineerflies", "ie"=>"Shift_JIS", "source"=>"hp"} and HTTP headers {"HTTP_REFERER"=>"https://www.google.com/"}<br /></pre><br /><br /><h2>Then</h2><pre class="ruby" name="code"> Then /^I should see a link to "([^\"]*)" with text "([^\"]*)"$/ do |url, text|<br />  #response bodyにはセレクター"a[href='#{ url }']"で指定した要素があるはず<br />  response_body.should have_selector("a[href='#{ url }']") do |element|<br />  #セレクターで取得された要素はtextを含んでいるはず<br />  element.should contain(text)<br />  end<br /> end<br /></pre><pre class="prettyprint"> <br />Feature: Search Google<br />  In order to make sure people can find my documentation<br />  I want to check it is listed on the first page in Google<br /><br />  Scenario: Searching for suzukimilanpaak engineerflies                                         # features/search.feature:5<br />    Given I have opened "https://www.google.com/"                                               # features/step_definitions/search_steps.rb:1<br />Sorry, you need to install launchy to open pages: `gem install launchy`<br />    When I search for "suzukimilanpaak engineerflies"                                           # features/step_definitions/search_steps.rb:5<br />    Then I should see a link to "/url?q=http://engineerflies.blogspot.com" with text "Cucumber" # features/step_definitions/search_steps.rb:14<br /><br />1 scenario (1 passed)<br />3 steps (3 passed)<br />0m1.292s<br /></pre>どうでしょう、３stepsとも通りましたでしょうか？<br/><br/><br/><h1>まとめ</h1>以上のようにCucumberを使ったBDDでは、まずFeatureとScenarioを作成します。それから出来上がったScenarioをWebrat（首なしブラウザ）がブラウジングして結果をRspecの関数などでチェックします。このステップは自然言語であるGerhkinに正規表現でマッチするScenarioをどんどんプログラミングコードに落とすというようなことをすることになります。前者のステップまでをQA Scenario Writer、後者のステップからはQA Engineerが担当しRubyのコードをどんどん書くというふうに担当を分けることもできます。この時RubyをDSL(Domain Specific Language - ドメイン固有言語)と呼びます。実際のRubyでBDDを行っている現場では、簡易的なドメイン固有言語としてRubyのコードを最低限書けることというがQAの採用の条件になっていることがほとんどです。<br/><br/><a href='http://gherkineditor.codeplex.com/'>Gerhkin編集専用のテキストエディタ</a>も出ていました。ずいぶんと一般化してきている印象  .