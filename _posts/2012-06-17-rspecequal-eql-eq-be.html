---
layout: post
title: RSpecのequal, eql, eq, be の違い
date: '2012-06-17T06:36:00.001+01:00'
author: Suzuki MilanPaak
tags:
- Ruby/ Ruby on Rails
modified_time: '2012-06-17T06:39:52.016+01:00'
blogger_id: tag:blogger.com,1999:blog-6758697817819098194.post-20968713072103515
blogger_orig_url: http://engineerflies.blogspot.com/2012/06/rspecequal-eql-eq-be.html
---

RSeqでshould equalと書くべきかeqlと書くべきか、それともbeと書くべきか時々混乱するのでこの際覚えてしまおうと意味で何がちがうんだろうと見てみた。それによるとごく簡単にまとめると以下のような結果だった。<br /><br />二つの変数を比較するとき；<br /><br /><br /><ul><li>変数の値だけを比べる</li><b>eql</b>   <b>eq</b><li>変数の値だけでなく、インスタンスのobject_idまで比べる</li><b>equal</b>   <b>be</b> </ul>と、ここまで覚えておけばSpec書くのに支障はない。<br /><br /><br />もう少し掘り下げると、それぞれ以下のような仕組みになっている。<br /><br /><h3>eql</h3><a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/eql.rb'>Matcherの場所はここ</a>。実際にはObject#eql?を呼んでいる。<br /><br />> arr.eql? :a => 1, :b => 2<br />=> true<br /><br /><br /><h3>equal</h3><a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/equal.rb'>Matcherの場所はここ</a>。実際にはObject#equal?を呼んでいる<br /><br />> arr.equal? :a => 1, :b => 2<br />=> false<br /><br /><br /><h3>eq</h3>eqの定義は<a href='http://stackoverflow.com/a/9797559/273182'>DSLの方</a>にあるらしい。<br /><br /><br /><h3>be</h3><a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/be.rb#L236'>Matcherの定義はここ</a>。beに引数があれば<a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/be.rb#L187'>BeSameAs#matches?</a>がshouldによって呼ばれる仕組みになっている。<br /><br /><br /><br /><br />整理して実際に試してみよう。以下のようにString, Array, Fixnumの型のインスタンスについてそれぞれeq, eql, equal, beのマッチャでSpecを実施してみた。<br /><br /># ./tmp_spec.rb<br /><pre name='code' class='ruby'>require 'rspec'<br /><br />describe 'eq' do<br />  it('should find two strings are equal') { "".should eq ""}<br />  it('should find two Arrays are equal') { {:a => 1}.should eq :a => 1 }<br />  it('should find two Fixnums are equal') { 1.should eq 1 }<br />end<br /><br />describe 'eql' do<br />  it('should find two strings are equal') { "".should eql ""}<br />  it('should find two Arrays are equal') { {:a => 1}.should eql :a => 1 }<br />  it('should find two Fixnums are equal') { 1.should eql 1 }<br />end<br /><br />describe 'equal' do<br />  it('should find two Strings are equal') { "".should equal ""}<br />  it('should find two Arrays are equal') { {:a => 1}.should equal :a => 1 }<br />  it('should find two Fixnums are equal') { 1.should equal 1 }<br />end<br /><br />describe 'be' do<br />  it('should find two strings are equal') { "".should be ""}<br />  it('hould find two Arrays are equal') { {:a => 1}.should be :a => 1 }<br />  it('should find two Fixnums are equal') { 1.should be 1 }<br />end<br /></pre><br /><br />結果は以下のとおり。equalとbeでは　String, Arrayではobject_idまで同じかチェックしている。<br /><pre name='code' class='prettyprint'>$ rspec tmp_spec.rb -f doc<br /><br />eq<br />  should find two strings are equal<br />  should find two Arrays are equal<br />  should find two Fixnums are equal<br /><br />eql<br />  should find two strings are equal<br />  should find two Arrays are equal<br />  should find two Fixnums are equal<br /><br />equal<br />  should find two Strings are equal (FAILED - 1)<br />  should find two Arrays are equal (FAILED - 2)<br />  should find two Fixnums are equal<br /><br />be<br />  should find two strings are equal (FAILED - 3)<br />  hould find two Arrays are equal (FAILED - 4)<br />  should find two Fixnums are equal<br /><br />Failures:<br /><br />  1) equal should find two Strings are equal<br />     Failure/Error: it('should find two Strings are equal') { "".should equal ""}<br />       <br />       expected #<String:79962750> => ""<br />            got #<String:79962730> => ""<br />       <br />       Compared using equal?, which compares object identity,<br />       but expected and actual are not the same object. Use<br />       'actual.should == expected' if you don't care about<br />       object identity in this example.<br />     # ./tmp_spec.rb:16:in `block (2 levels) in <top (required)>'<br /><br />  2) equal should find two Arrays are equal<br />     Failure/Error: it('should find two Arrays are equal') { {:a => 1}.should equal :a => 1 }<br />       <br />       expected #<Hash:79945050> => {:a=>1}<br />            got #<Hash:79945060> => {:a=>1}<br />       <br />       Compared using equal?, which compares object identity,<br />       but expected and actual are not the same object. Use<br />       'actual.should == expected' if you don't care about<br />       object identity in this example.<br />       <br />       <br />       Diff:{:a=>1}.==({:a=>1}) returned false even though the diff between {:a=>1} and {:a=>1} is empty. Check the implementation of {:a=>1}.==.<br />     # ./tmp_spec.rb:17:in `block (2 levels) in <top (required)>'<br /><br />  3) be should find two strings are equal<br />     Failure/Error: it('should find two strings are equal') { "".should be ""}<br />       <br />       expected #<String:79934250> => ""<br />            got #<String:79934260> => ""<br />       <br />       Compared using equal?, which compares object identity,<br />       but expected and actual are not the same object. Use<br />       'actual.should == expected' if you don't care about<br />       object identity in this example.<br />     # ./tmp_spec.rb:22:in `block (2 levels) in <top (required)>'<br /><br />  4) be hould find two Arrays are equal<br />     Failure/Error: it('hould find two Arrays are equal') { {:a => 1}.should be :a => 1 }<br />       <br />       expected #<Hash:79932410> => {:a=>1}<br />            got #<Hash:79932420> => {:a=>1}<br />       <br />       Compared using equal?, which compares object identity,<br />       but expected and actual are not the same object. Use<br />       'actual.should == expected' if you don't care about<br />       object identity in this example.<br />       <br />       <br />       Diff:{:a=>1}.==({:a=>1}) returned false even though the diff between {:a=>1} and {:a=>1} is empty. Check the implementation of {:a=>1}.==.<br />     # ./tmp_spec.rb:23:in `block (2 levels) in <top (required)>'<br /><br />Finished in 0.01339 seconds<br />12 examples, 4 failures<br /><br />Failed examples:<br /><br />rspec ./tmp_spec.rb:16 # equal should find two Strings are equal<br />rspec ./tmp_spec.rb:17 # equal should find two Arrays are equal<br />rspec ./tmp_spec.rb:22 # be should find two strings are equal<br />rspec ./tmp_spec.rb:23 # be hould find two Arrays are equal<br /></pre><br /><br />でもこのFixnumの比較に関しては Specが成功してしまう。<br /><pre name='code' class='ruby'>describe 'be' do<br />  it('should find two Fixnums are equal') { 1.should be 1 }<br />end<br /></pre><br />これはFixnumのidがrubyを起動時に実行されて既に予約済みだからのようだ<br /><br />irb/ pry<br /><pre name='code' class='ruby'>[28] pry(main)> 1.object_id<br />=> 3<br />[29] pry(main)> 2.object_id<br />=> 5<br />[30] pry(main)> 3.object_id<br />=> 7<br />[35] pry(main)> 1.object_id<br />=> 3<br /><br /><br />[32] pry(main)> 1.0.object_id<br />=> 105431370<br /></pre><br />このようにFixnumのインスタンスはシングルトンで定義されているようだ。