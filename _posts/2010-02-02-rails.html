---
layout: post
title: rails ルートの操作
date: '2010-02-02T19:51:00.024Z'
author: Suzuki MilanPaak
tags:
- Ruby/ Ruby on Rails
modified_time: '2010-08-02T19:22:44.478+01:00'
blogger_id: tag:blogger.com,1999:blog-6758697817819098194.post-1152904022977429872
blogger_orig_url: http://engineerflies.blogspot.com/2010/02/rails.html
---

久しぶりにrailsの復習をしています。理解がおざなりだった部分とかも混ぜてちょっとずつちょっとずつ積み立てる予定。しばらくはこの状態が続きそう  <br /><br />今回はルートの操作のメモです。リクエストのルーティングがうまく通っているか確認したり、ルーティングを作成する方法を復習します。  <br /><br />サンプルコードを作ります。フィードを一覧、登録、編集するFeedsControllerを作ります。 <br /><pre class=prettyprint>rails -d mysql sample_routes ruby script/generate scaffold feeds<br /></pre><br /><br />config/routes.rbで以下のルート定義が既に行われているものとします。 <br /><pre name=code class=ruby>#関係あるのはこっちだけ<br />map.resources :feeds<br /><br />map.connect ':controller/:action/:id'<br />map.connect ':controller/:action/:id.:format'<br /></pre><br />scaffoldしたのでroutes.rbには既に自動で2行目のRestfulなマッピングが定義されているはずです。４、５行目はrailsコマンドでプロジェクトを作成したときに既に作成されているものです。  <br /><br />まずはscript/consoleを使ってRoutesオブジェクトを取得します。  <br /><pre class="prettyprint">$ ruby script/consoleLoading<br />development environment (Rails 2.3.5)<br />>> rs = ActionController::Routing::Routes<br /></pre><br /><br /><h2>定義されたルートの確認</h2><br /><br /><pre class=prettyprint>>>puts rs.routes<br />GET    /feeds(.:format)?                        {:controller=>"feeds", :action=>"index"}<br />POST   /feeds(.:format)?                        {:controller=>"feeds", :action=>"create"}<br />GET    /feeds/new(.:format)?                    {:controller=>"feeds", :action=>"new"}<br />GET    /feeds/:id/edit(.:format)?               {:controller=>"feeds", :action=>"edit"}<br />GET    /feeds/:id(.:format)?                    {:controller=>"feeds", :action=>"show"}<br />PUT    /feeds/:id(.:format)?                    {:controller=>"feeds", :action=>"update"}<br />DELETE /feeds/:id(.:format)?                    {:controller=>"feeds", :action=>"destroy"}::<br /></pre><br />出力される項目は左からHTTP Method、ルート定義、割り当てられるコントローラ／アクション。  <br /><br />またはrake taskからでもルート定義を表示できます <br /><pre class=prettyprint>$rake routes<br /><br />#grepが使える<br />$rake routes|grep feeds<br /></pre><br /><br /><h2>URLから割り当てられるコントローラ、アクションを見つける</h2><br /><br /><pre class=prettyprint>>> rs.recognize_path<br />"/feeds"=> {:controller=>"feeds", :action=>"index"}<br /></pre><br /><br />混乱を避けるためmethodは指定しておいた方が良いです。 <br /><pre class=prettyprint>>> rs.recognize_path '/feeds/1'<br />=> {:controller=>"feeds", :action=>"1"}<br />>> rs.recognize_path '/feeds/1', :method=>:get<br />=> {:controller=>"feeds", :action=>"show", :id=>"1"}<br /></pre><br /><br />また、そもそもコントローラが実装されていない場合はルートはマッチしません <br /><pre class=prettyprint>>> rs.recognize_path '/foo'<br />ActionController::RoutingError:<br />No route matches "/foo" with {} from /opt/ruby-enterprise-1.8.7/lib/ruby/gems/1.8/gems/actionpack-2.3.5/lib/action_controller/routing/recognition_optimisation.rb:66:in <br />`recognize_path' from (irb):24<br /></pre><br /><br /><h2>コントローラ、アクションからURLを逆引きする</h2><br /><pre class=prettyprint>#コントローラだけ指定すると期待した動作をする。<br />>> rs.generate :controller => :feeds<br />=> "/feeds"#idを指定すると定義されていないURLが帰ってくる<br />>> rs.generate :controller => :feeds, :id => '123'<br />=> "/feeds?id=123"#recognize_pathでマッチしないルートなのでまあ無視しておこう。。。<br />>> rs.recognize_path '/feeds?id=123'<br />ActionController::RoutingError: No route matches "/feeds?id=123"<br />with {} from /opt/ruby-enterprise-1.8.7/lib/ruby/gems/1.8/gems/actionpack-2.3.5/lib/action_controller/routing/recognition_optimisation.rb:66:in <br />`recognize_path' from (irb):20<br /></pre><br /><br /><h2>作成前のコントローラのルートを作成する</h2><br /><pre class=prettyprint>#use_controllers! [”name_of_controller”]<br />>> ActionController::Routing.use_controllers! ['entries']<br />=> ["entries"]<br />#ルート定義をリロードしないとコントローラが有効にならない<br />>> load 'config/routes.rb'=> []<br />#確認<br />>> rs.recognize_path '/entries/show/1'<br />=> {:controller=>"entries", :action=>"show", :id=>"1"}<br />#routes.rbのmapの設定を行っていないのでこうなる。<br />>> rs.recognize_path '/entries/1'=> {:controller=>"entries", :action=>"1"}<br /></pre><br /><br />http://api.rubyonrails.org/classes/ActionController/Routing/RouteSet/Mapper.html<br /><br /><br /><br /><h1>ActionController::Routing::Routes.drawのブロック中の操作</h1><br /><br />準備<br /><pre class=prettyprint>>> rs = ActionController::Routing::Routes<br />>> map = ActionController::Routing::RouteSet::Mapper.new rs<br /></pre><br /><br />map.root<br /><pre class=prettyprint>>> map.root :controller => "welcom", :action => "index"<br />=><br />ANY    /                                        {:controller=>"welcome", :action=>"index"}<br /></pre><br /><br />map.connect <br /><pre class=prettyprint>>>   map.connect ':controller/ajax/:action'<br />=><br />ANY    /:controller/ajax/:action/               {}<br /></pre><br /><br />map.resources<br /><pre class=prettyprint>>>   map.resources :feeds<br />=><br />GET    /feeds(.:format)?                        {:controller=>"feeds", :action=>"index"}<br />POST   /feeds(.:format)?                        {:controller=>"feeds", :action=>"create"}<br />GET    /feeds/new(.:format)?                    {:controller=>"feeds", :action=>"new"}<br />GET    /feeds/:id/edit(.:format)?               {:controller=>"feeds", :action=>"edit"}<br />GET    /feeds/:id(.:format)?                    {:controller=>"feeds", :action=>"show"}<br />PUT    /feeds/:id(.:format)?                    {:controller=>"feeds", :action=>"update"}<br />DELETE /feeds/:id(.:format)?                    {:controller=>"feeds", :action=>"destroy"}<br /></pre><br /><br />map.resource<br /><pre class=prettyprint>>> map.resource :daily_sum<br />=> <br />GET    /daily_sum/new(.:format)?                {:controller=>"daily_sums", :action=>"new"}<br />GET    /daily_sum/edit(.:format)?               {:controller=>"daily_sums", :action=>"edit"}<br />GET    /daily_sum(.:format)?                    {:controller=>"daily_sums", :action=>"show"}<br />PUT    /daily_sum(.:format)?                    {:controller=>"daily_sums", :action=>"update"}<br />DELETE /daily_sum(.:format)?                    {:controller=>"daily_sums", :action=>"destroy"}<br />POST   /daily_sum(.:format)?                    {:controller=>"daily_sums", :action=>"create"}<br /></pre><br />map.resource<b>s</b>と比較した違い<br />- indexがない<br />- リソースが単一なので:idをURLに使用しない<br /><br />resourceのオプション<br />- :member, :collection<br />map.resources :japan :member => {:county => :get}, :collection => {:progress_population => :get}<br />  member => /nihon/:id/history,   collection => /nihon/log<br /><br />map.named_route<br /><pre class=prettyprint>>> map.named_route 'error_occurred', '/:controller/internal_server_error', {:action=>"resque"}<br />=> <br />ANY    /:controller/internal_server_error/      {:action=>"resque"}<br /></pre><br /><br /><br />map.namespace<br /><pre class=prettyprint>>> map.namespace :admin do |admin|<br />>>  admin.resources :users<br />>>  admin.connect ':controller/:action/:id'<br />>> end<br />=><br />GET    /admin/users(.:format)?                  {:controller=>"admin/users", :action=>"index"}<br />POST   /admin/users(.:format)?                  {:controller=>"admin/users", :action=>"create"}<br />GET    /admin/users/new(.:format)?              {:controller=>"admin/users", :action=>"new"}<br />GET    /admin/users/:id/edit(.:format)?         {:controller=>"admin/users", :action=>"edit"}<br />GET    /admin/users/:id(.:format)?              {:controller=>"admin/users", :action=>"show"}<br />PUT    /admin/users/:id(.:format)?              {:controller=>"admin/users", :action=>"update"}<br />DELETE /admin/users/:id(.:format)?              {:controller=>"admin/users", :action=>"destroy"}<br />ANY    /admin/:controller/:action/:id/          {}<br /></pre><br /><br />map.method_missing(定義されていないメソッド)<br /><pre class=prettyprint>>> map.login '/login', :controller => 'sessions', :action => 'new'<br />>> map.logout '/logout', :controller => 'sessions', :action => 'destroy'<br />=><br />ANY    /login/                                  {:controller=>"sessions", :action=>"new"}<br />ANY    /logout/                                 {:controller=>"sessions", :action=>"destroy"}<br /></pre>