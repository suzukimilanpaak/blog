---
layout: post
title: RSpecのshouldは何をしてるの？　RSpecの仕組み
date: '2012-06-04T17:06:00.003+01:00'
author: Suzuki MilanPaak
tags:
- Ruby/ Ruby on Rails
modified_time: '2012-06-04T17:29:54.214+01:00'
blogger_id: tag:blogger.com,1999:blog-6758697817819098194.post-2740206096405086535
blogger_orig_url: http://engineerflies.blogspot.com/2012/06/rspecshould.html
---

RSpecのshouldはどうやって動いているのか？..という仕組みについてpaperboy&co.の方が既にcodeを読んで解説されているスライドを見つけました。<br /><br />まずshouldが全てのinstaceで実効可能なのは<a href='http://banyan.github.com/slides/20120321/#/step-12'>Kernel classに対して定義されている</a>からです。<br /><br /><a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/expectations/extensions/kernel.rb#L26'>shouldの居場所</a><br /><pre class='ruby' name='code'># spec/expectations/extensions/kernel.rb<br />def should(matcher=nil, message=nil, &block)<br />  Spec::Expectations::PositiveExpectationHandler.handle_matcher(self, matcher, message, &block)<br />end<br /></pre><br /><a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/expectations/handler.rb#L5'>PositiveExpectationHandler#handle_matcherの居場所</a><br /><pre class='ruby' name='code'># spec/expectations/handler.rb<br />match = matcher.matches?(actual, &block)<br /></pre><br /><br /><br /><h3><a href='http://banyan.github.com/slides/20120321/#/step-9'>RSpecの構造</a></h3><pre>/lib<br />└── spec<br />    ├── expectations<br />    │   └── extensions<br />    └── matchers<br />        └── extensions<br /></pre><br />expectations/extensionsはその名のとおり拡張を行う。<a href='https://github.com/dchelimsky/rspec/tree/master/lib/spec/expectations/extensions'>spec/expectations/extensions/にはkernel.rbのみがある</a>。<br /><br /><a href='http://banyan.github.com/slides/20120321/#/step-9'>RSpecの構造</a><br /><a href='https://github.com/dchelimsky/rspec/tree/master/lib/spec/matchers'>spec/matchers</a>には見慣れた名前が。。<br /><br />ずっとshouldはきっと variable.be_a Stringてかくと variable.is_a? Stringって変えてくれると想像して信じていたけど、実際の条件は逐一Matcherに書いてあるらしい。例えば<a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/be_kind_of.rb'>be_kind_of matcher</a><br /><pre class='ruby' name='code'>def be_a_kind_of(expected)<br />  Matcher.new :be_a_kind_of, expected do |_expected_|<br />    match do |actual|<br />      actual.kind_of?(_expected_)<br />    end<br />  end<br />end<br /></pre><br />be Matcherには<a href='http://banyan.github.com/slides/20120321/#/step-31'>僕が想像していたような機能がある</a><br /><br />§<br /><br />Matcherを自作したい時は Object.should be_fine => Object.fine?の法則に当てはまるfine? methodを持つObject定義してあげるか、matches?にrespondするMatcherを書いて<a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers.rb'>matcher.rb</a>みたいに requireしてあげればいいはず。<br /><br /><br />§<br /><br /><br /><h3>蛇足だけど</h3>上記 kernel.rbのとおり<a href='http://kerryb.github.com/iprug-rspec-presentation/#34'>引数にmessageを渡してfailure時に何が失敗したのかわかりやすくすることもできる</a><br /><br />別のshould、<a href='https://github.com/rspec/rspec-core/blob/master/lib/rspec/core/subject.rb#L62'>Subject#shouldの居場所</a><br />これは以下の用に書いたときのshouldにちがいない（と信じてる）<br /><pre name='code' class='ruby'>let(:int) { 16 }<br />subject { int }<br /><br />it "should be even" do<br />  should be_even<br />end<br /></pre><br /><br /><h3>Change</h3>例えばこんな感じに書いたときは<br /><pre>expect{ array << 42 }.to change{ array.size }.from(0).to(1)<br /></pre><a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/change.rb#L4'>initializeで @value_proc に{ array << 42 }が代入されて</a>、<a href='https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/change.rb#L78'>from methodで@fromに0が、to methodで@to に1が代入される。</a>比較は他のmatchers同様<a href=https://github.com/dchelimsky/rspec/blob/master/lib/spec/matchers/change.rb#L11>matches?</a>で @beforeと@afterを比較して行われる。event_procには array.sizeが代入される。  <pre class='ruby' name='code'>@before = evaluate_value_proc<br />event_proc.call<br />@after = evaluate_value_proc<br /></pre><a href='http://banyan.github.com/slides/20120321/#/step-4'>スライド</a>すばらしいので全部読むべし<br /><br /><br />